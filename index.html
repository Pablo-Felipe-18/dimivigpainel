<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <link rel="manifest" href="manifest.json" />
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DIMIVIG</title>
  <link rel="icon" type="image/png" href="DIMIVIGLOGO.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      padding: 20px;
      background-color: #000;
      color: #fff;
    }
    .form-control, .form-select {
      background-color: #1a1a1a;
      border: 1px solid orange;
      color: #fff;
      text-transform: uppercase;
    }
    .form-control::placeholder {
      color: #ccc;
    }
    .btn-primary {
      background-color: orange;
      border-color: orange;
    }
    .btn-primary:hover {
      background-color: #ff9900;
    }
    .table {
      color: #fff;
      background-color: #1a1a1a;
    }
    .table th, .table td {
      color: #fff;
      background-color: #2a2a2a;
    }
    .table thead th {
      background-color: #ff6600;
      color: #fff;
    }
    .logo {
      display: block;
      margin: 0 auto 20px auto;
      max-width: 200px;
    }
    .text-orange {
      color: orange;
    }
    .table tbody tr:hover {
      background-color: #333;
    }
    .table-section {
      background-color: #111;
      padding: 15px;
      border-radius: 8px;
    }
    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 10px;
    }
    .pagination button {
      background-color: orange;
      color: black;
      border: none;
      margin: 0 5px;
      padding: 5px 10px;
      border-radius: 4px;
    }
    .pagination span {
      margin: 0 10px;
      align-self: center;
    }
    #relatorioContainer {
      display: none;
      background-color: #222;
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <img src="DIMIVIGLOGO.png" alt="Logo Dimivig" class="logo">
    <h3 class="text-center mb-4 text-orange">DIMIVIG</h3>
    <div class="row">
      <div class="col-12 col-md-6">
        <form id="formEntrada">
          <input id="nome" placeholder="Nome" required class="form-control mb-2">
          <input id="placa" placeholder="Placa" required class="form-control mb-2">
          <input id="empresa" placeholder="Empresa" required class="form-control mb-2">
          <input id="telefone" placeholder="Telefone" required class="form-control mb-2">
          <input id="modelo" placeholder="Modelo do Veículo" class="form-control mb-2">
          <input id="setor" placeholder="Setor de Destino" class="form-control mb-2">
          <input id="autorizadoPor" placeholder="Autorizado por?" class="form-control mb-2">
          <button type="submit" class="btn btn-primary w-100">Salvar</button>
        </form>
        <ul id="listaDados" class="mt-4 text-white"></ul>
      </div>
      <div class="col-12 col-md-6">
        <div class="table-section">
          <h5>Visitantes Atuais</h5>
          <table class="table">
            <thead>
              <tr>
                <th>Nome</th>
                <th>Placa</th>
                <th>Entrada</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="tabelaVisitantes"></tbody>
          </table>
          <button class="btn btn-warning w-100 mt-2" onclick="gerarRelatorio()">Gerar Relatório</button>
          <div id="relatorioContainer">
            <input id="filtroRelatorio" class="form-control mt-2" placeholder="Filtrar por placa">
            <pre id="relatorio" class="mt-3" style="white-space: pre-wrap;"></pre>
            <button class="btn btn-sm btn-danger mt-2" onclick="fecharRelatorio()">Fechar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let visitantes = JSON.parse(localStorage.getItem('visitantes')) || [];
    let db;
    const request = indexedDB.open('offlineDB', 1);
    request.onupgradeneeded = event => {
      db = event.target.result;
      db.createObjectStore('fila', { autoIncrement: true });
    };
    request.onsuccess = event => {
      db = event.target.result;
      sincronizarOffline();
      renderizarLista();
      renderizarTabela();
    };

    function salvarOffline(dado) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction('fila', 'readwrite');
        const store = tx.objectStore('fila');
        const request = store.add(dado);
        request.onsuccess = () => resolve(true);
        request.onerror = () => reject(false);
      });
    }

    async function sincronizarOffline() {
      if (!navigator.onLine) return;
      const tx = db.transaction('fila', 'readwrite');
      const store = tx.objectStore('fila');
      const getAll = store.getAll();
      getAll.onsuccess = async () => {
        const dados = getAll.result;
        for (const dado of dados) {
          try {
            await fetch('https://script.google.com/macros/s/AKfycbxUX595HLdI5ZOhJgegu6BWXEnTIkZ68R7yG9o-3RknHUEENMcmo85PxzVMO0uqqEhPsg/exec', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(dado)
            });
            visitantes.push(dado);
          } catch (e) {
            console.error('Erro ao sincronizar:', e);
          }
        }
        store.clear();
        localStorage.setItem('visitantes', JSON.stringify(visitantes));
        renderizarTabela();
        alert("✅ Todos os dados offline foram sincronizados!");
      };
    }

    document.getElementById('formEntrada').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const dado = {
        nome: form.nome.value.toUpperCase(),
        placa: form.placa.value.toUpperCase(),
        empresa: form.empresa.value.toUpperCase(),
        telefone: form.telefone.value,
        modelo: form.modelo.value.toUpperCase(),
        setor: form.setor.value.toUpperCase(),
        autorizadoPor: form.autorizadoPor.value.toUpperCase(),
        entrada: new Date().toLocaleString("pt-BR", { timeZone: "America/Sao_Paulo", hour12: false })
      };

      if (navigator.onLine) {
        try {
          await fetch('https://script.google.com/macros/s/AKfycbxUX595HLdI5ZOhJgegu6BWXEnTIkZ68R7yG9o-3RknHUEENMcmo85PxzVMO0uqqEhPsg/exec', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dado)
          });
          visitantes.push(dado);
        } catch (e) {
          await salvarOffline(dado);
        }
      } else {
        await salvarOffline(dado);
      }

      localStorage.setItem('visitantes', JSON.stringify(visitantes));
      form.reset();
      renderizarLista();
      renderizarTabela();
    });

    function renderizarTabela() {
      const tabela = document.getElementById('tabelaVisitantes');
      tabela.innerHTML = '';
      visitantes.filter(v => !v.saida).forEach((v, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${v.nome}</td>
          <td>${v.placa}</td>
          <td>${v.entrada}</td>
          <td><button class="btn btn-sm btn-danger" onclick="confirmarSaida(${i})">Dar Saída</button></td>
        `;
        tabela.appendChild(tr);
      });
    }

    function confirmarSaida(i) {
      const modelo = visitantes[i].modelo || 'veículo';
      const confirmado = confirm(`Tem certeza que quer dar saída no '${modelo}'?`);
      if (!confirmado) return;

      visitantes[i].saida = new Date().toLocaleString("pt-BR", { timeZone: "America/Sao_Paulo", hour12: false });
      localStorage.setItem('visitantes', JSON.stringify(visitantes));
      renderizarTabela();

      if (navigator.onLine) {
        fetch('https://script.google.com/macros/s/AKfycbxUX595HLdI5ZOhJgegu6BWXEnTIkZ68R7yG9o-3RknHUEENMcmo85PxzVMO0uqqEhPsg/exec', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(visitantes[i])
        });
      } else {
        salvarOffline(visitantes[i]);
      }
    }

    function renderizarLista() {
      const lista = document.getElementById('listaDados');
      if (!lista) return;
      lista.innerHTML = '';
      const tx = db.transaction('fila', 'readonly');
      const store = tx.objectStore('fila');
      const getAll = store.getAll();
      getAll.onsuccess = () => {
        getAll.result.forEach(d => {
          const li = document.createElement('li');
          li.textContent = `${d.nome} - ${d.placa}`;
          lista.appendChild(li);
        });
      };
    }

    function gerarRelatorio() {
      const contagem = {};
      visitantes.forEach(v => {
        if (!contagem[v.placa]) contagem[v.placa] = 0;
        contagem[v.placa]++;
      });
      const relatorio = Object.entries(contagem).map(([placa, total]) => `Placa: ${placa} - Total: ${total}`).join('\n');
      document.getElementById('relatorio').textContent = relatorio;
      document.getElementById('relatorioContainer').style.display = 'block';
    }

    function fecharRelatorio() {
      document.getElementById('relatorioContainer').style.display = 'none';
    }

    window.addEventListener('online', sincronizarOffline);
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log('✅ Service Worker registrado'))
        .catch((err) => console.error('Erro ao registrar Service Worker:', err));
    }
  </script>
</body>
</html>
